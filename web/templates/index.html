{% extends "base.html" %}

{% block title %}Dashboard - VMEvalKit{% endblock %}

{% block content %}
<div class="page-header">
    <h1>VMEvalKit Results</h1>
    <p class="subtitle">{{ overview.total_models }} models ¬∑ {{ overview.total_domains }} domains ¬∑ {{ overview.total_inferences }} inferences</p>
    <div style="margin-top: 20px;">
        <button onclick="expandAll()" style="padding: 8px 16px; margin-right: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ‚ûï Expand All Models
        </button>
        <button onclick="collapseAll()" style="padding: 8px 16px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ‚ûñ Collapse All Models
        </button>
    </div>
    {% if hierarchy %}
    <div style="margin-top: 15px; padding: 15px; background-color: #fff3cd; border-radius: 6px; border: 1px solid #ffc107;">
        <strong>üìå Quick Navigation:</strong>
        {% for model in hierarchy %}
        <button onclick="navigateToModel('model-{{ loop.index }}')" 
                style="padding: 5px 10px; margin: 5px; background-color: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            ü§ñ {{ model }}
        </button>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Hierarchical View: Models ‚Üí Domains ‚Üí Tasks -->
{% for model, domains in hierarchy.items() %}
{% set outer_loop = loop %}
<section class="model-section">
    <div class="model-header" onclick="toggleSection('model-{{ loop.index }}')" style="cursor: pointer; background-color: #f0f4f8; padding: 15px; border-radius: 8px; margin-bottom: 10px; transition: background-color 0.3s;">
                <h2>
                    <span class="expand-icon" id="icon-model-{{ loop.index }}">{% if loop.first %}‚ñº{% else %}‚ñ∂{% endif %}</span>
            ü§ñ {{ model }}
            <span class="badge">{{ domains.values()|map('length')|sum }} tasks</span>
            <span style="float: right; color: #666; font-size: 14px;">Click to {% if loop.first %}collapse{% else %}expand{% endif %}</span>
        </h2>
    </div>
    
    <div class="model-content" id="model-{{ loop.index }}" style="display: {% if loop.first %}block{% else %}none{% endif %}">
        {% for domain, tasks in domains.items() %}
        <div class="domain-section">
            <div class="domain-header" onclick="toggleSection('domain-{{ outer_loop.index }}-{{ loop.index }}')" style="cursor: pointer; background-color: #f8f9fa; padding: 10px 15px; border-radius: 6px; margin-bottom: 8px; transition: background-color 0.3s;">
                <h3>
                    <span class="expand-icon" id="icon-domain-{{ outer_loop.index }}-{{ loop.index }}">{% if outer_loop.first and loop.first %}‚ñº{% else %}‚ñ∂{% endif %}</span>
                    {% if domain == 'chess' %}‚ôüÔ∏è{% elif domain == 'maze' %}üåÄ{% elif domain == 'raven' %}üß©{% elif domain == 'rotation' %}üîÑ{% elif domain == 'sudoku' %}üî¢{% else %}üìù{% endif %}
                    {{ domain|title }}
                    <span class="badge">{{ tasks|length }} tasks</span>
                    <span style="float: right; color: #999; font-size: 12px;">Click to toggle</span>
                </h3>
            </div>
            
            <div class="domain-content" id="domain-{{ outer_loop.index }}-{{ loop.index }}" style="display: {% if outer_loop.first and loop.first %}block{% else %}none{% endif %}">
                <div class="tasks-grid">
                    {% for task in tasks %}
                    <div class="task-card">
                        <!-- Task Header -->
                        <div class="task-header">
                            <span class="task-id">{{ task.task_id }}</span>
                        </div>
                        
                        <!-- Input Image -->
                        {% if task.first_frame %}
                        <div class="task-image-section">
                            <h4>Input Image</h4>
                            <img src="/image/{{ task.first_frame.replace(config.OUTPUT_DIR|string, '').lstrip('/') }}" 
                                 alt="Input" class="task-image" loading="lazy">
                        </div>
                        {% endif %}
                        
                        <!-- Prompt -->
                        {% if task.prompt %}
                        <div class="task-prompt-section">
                            <h4>Prompt</h4>
                            <p class="task-prompt">{{ task.prompt }}</p>
                        </div>
                        {% endif %}
                        
                        <!-- Output Video -->
                        {% if task.video_path %}
                        <div class="task-video-section">
                            <h4>Generated Video</h4>
                            <video controls preload="none" class="task-video" loading="lazy">
                                <source src="/video/{{ task.video_path.replace(config.OUTPUT_DIR|string, '').lstrip('/') }}" type="video/mp4">
                                Your browser does not support video playback.
                            </video>
                        </div>
                        {% endif %}
                        
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endfor %}

{% if not hierarchy %}
<div class="empty-state">
    <div class="empty-icon">üì≠</div>
    <h2>No Results Found</h2>
    <p>Run some experiments first to see results here!</p>
    <pre>python examples/experiment_2025-10-14.py</pre>
</div>
{% endif %}

<script>
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById('icon-' + sectionId);
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.textContent = '‚ñº';
    } else {
        section.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}

function expandAll() {
    // Expand all model sections
    {% for model in hierarchy %}
    document.getElementById('model-{{ loop.index }}').style.display = 'block';
    document.getElementById('icon-model-{{ loop.index }}').textContent = '‚ñº';
    {% endfor %}
}

function collapseAll() {
    // Collapse all model sections
    {% for model in hierarchy %}
    document.getElementById('model-{{ loop.index }}').style.display = 'none';
    document.getElementById('icon-model-{{ loop.index }}').textContent = '‚ñ∂';
    {% endfor %}
}

function navigateToModel(modelId) {
    // First ensure the section is expanded
    const section = document.getElementById(modelId);
    const icon = document.getElementById('icon-' + modelId);
    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.textContent = '‚ñº';
    }
    // Then scroll to it
    setTimeout(function() {
        document.getElementById(modelId).parentElement.scrollIntoView({behavior: 'smooth', block: 'start'});
    }, 100);
}

// Add hover effects to clickable headers
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effect to model headers
    document.querySelectorAll('.model-header').forEach(header => {
        header.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e1e8f0';
        });
        header.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#f0f4f8';
        });
    });
    
    // Add hover effect to domain headers
    document.querySelectorAll('.domain-header').forEach(header => {
        header.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#eef0f2';
        });
        header.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
    });
});

// Lazy load videos as they come into view
document.addEventListener('DOMContentLoaded', function() {
    if ('IntersectionObserver' in window) {
        const videoObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const video = entry.target;
                    if (video.preload === 'none') {
                        video.preload = 'metadata';
                    }
                    videoObserver.unobserve(video);
                }
            });
        }, {
            rootMargin: '100px'
        });
        
        document.querySelectorAll('video[preload="none"]').forEach(video => {
            videoObserver.observe(video);
        });
    }
});
</script>

{% endblock %}
